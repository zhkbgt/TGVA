<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width" />
  <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
  <link rel="stylesheet" type="text/css" href="../../css/aui/aui.css" />
  <link rel="stylesheet" href="../../css/custom/common.css">
</head>

<body>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script src="../../script/ajax.js"></script>
<script type="text/javascript">
  var _extends = Object.assign || function (target) {
    for (var i = 1; i < arguments.length; i++) {
      var source = arguments[i];
      for (var key in source) {
        if (Object.prototype.hasOwnProperty.call(source, key)) {
          target[key] = source[key];
        }
      }
    }
    return target;
  };

  var id;

  apiready = function apiready() {
    var isBanner = api.pageParam.isBanner;

    id = api.pageParam.id;

    isBanner ? fetchVideoFromBanner() : fetchVideo();
  };

  function fetchVideoFromBanner() {
    $ajax_post('appvideo/video_from_banner', {
      user_id: 100000,
      banner_id: id
    }, function (res) {
      var video = _extends({}, res.video);

      fetchComments(video);
    });
  }

  function fetchVideo() {
    $ajax_post('appvideo/video_detail', {
      user_id: 100000,
      video_id: id
    }, function (res) {
      var video = _extends({}, res.video);

      fetchComments(video);
    });
  }

  function fetchComments(data) {
    $ajax_post('appcomment/comment_list', {
      user_id: 100000,
      id: id,
      page: 1,
      page_count: 10,
      type: 1,
    }, function (res) {
      var comments = _extends({}, res);

      renderFrame(data, comments);
    });
  }

  function renderFrame(data, comments) {
    // 渲染页面

    sendEventVideoPlay();

    api.openFrame({
      name: 'video_' + id + '_datail_frm',
      url: './video_datail_frm.html',
      bounces: false,
      useWKWebView: true,
      rect: {
        x: 0,
        y: 0,
        w: 'auto',
        h: 'auto'
      },
      pageParam: {
        video: data,
        comments: comments
      }
    });
  }

  function forbidSlidBackForIOS() {
<!--      alert(321)-->
    // 禁止iOS右滑返回，否则无法正常关闭并清理播放器
    api.setWinAttr({
      slidBackEnabled: false
    });
  }

  function addEventListenerKeyback() {
<!--      alert(123)-->
    // 监听Android返回键，根据视频播放器是否全屏进行处理
    api.addEventListener({
      name: 'keyback'
    }, function (ret, err) {
      console.log(id)
      api.execScript({
        frameName: 'video_' + id + '_datail_frm',
        script: 'vm.fnIsPlayerFull();'
      });
    });
  }

  function addEventListenerMenu() {
    // 监听返回首页或呼出多任务，及应用进入后台
    api.addEventListener({
      name: 'pause'
    }, function (ret, err) {
      api.execScript({
        frameName: 'video_' + id + '_datail_frm',
        script: 'vm.fnPausePlayer();'
      });
      // alert('应用进入后台')
    });
  }

  function sendEventVideoPlay() {
    // 发送自定义事件 videoPlay, 防止与音频同时播放的冲突
    api.sendEvent({
      name: 'videoPlay',
    });
  }
</script>

</html>
