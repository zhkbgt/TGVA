<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width" />
  <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
  <link rel="stylesheet" type="text/css" href="../../css/aui/aui.css" />
  <link rel="stylesheet" href="../../css/custom/common.css">
  <style></style>
</head>

<body>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script src="../../script/ajax.js"></script>
<script type="text/javascript">
  var _localId = null, // 记录在本地的audio_id
    _currentId = null; // 当前audio_id, 用于和本地的audio_id对比判断是否切换播放源
  // var _path = [];    // 记录当前路径

  apiready = function () {
    _currentId = api.pageParam.id;

    if (!_currentId) {
      api.toast({
        msg: '当前暂无播放源',
        duration: 1500,
        location: 'middle'
      });

      setTimeout(() => {
        api.closeWin();
      }, 1500);

      return;
    }

    handleSystemBack();
    // addEventListenerVideoPlay();
    
    _localId = Number(localStorage.getItem('local_audio_id'));

    console.log(_localId + '_' + _currentId)
    fetchData(_localId !== _currentId);

    // _path = getPath();
    // recordPath(api.pageParam.from);

    // api.addEventListener({
    //   name: 'viewappear'
    // }, function (ret, err) {
    //   _localId = Number(localStorage.getItem('local_audio_id'));

    //   console.log(id + '_' + _currentId)
    //   fetchData(_localId === _currentId);

    //   _localId === _currentId ?
    //     fetchData(false) :
    //     fetchData(true);
    // });

    // api.addEventListener({
    //   name: 'viewdisappear'
    // }, function(ret, err){
    //   console.log(JSON.stringify(api.pageParam))
    //   localStorage.setItem('audio_path', _path.join('|'));
    // });
  };

  /* function getPath() {
    // 获取当前打开audio窗口的路径
    // openWin的reload属性会再次执行apiready()外部代码，只能再用本地存储来完成
    var res = localStorage.getItem('audio_path');
    if (res) {
      res = res.split('|');
      console.log(JSON.stringify(res))
      return res;
    } else return [];
  } */

  /* function recordPath(from) {
    console.log(from)
    // 讲跳转路径放入数组记录，以供后退时使用
    if (_path.indexOf(from) === -1) {
      // 若from不存在，将其加入path
      _path.push(from);
    } else {
      // from已存在，将其放到末尾
      var i = _path.indexOf(from),
        temp = _path[_path.length - 1];
      
      _path[i] = temp;
      _path[_path.length - 1] = from;
    }

    console.log(JSON.stringify(_path))
  } */

  function handleSystemBack() {
    // 处理系统级的返回操作
    var sys = api.systemType;

    if (sys === 'android') {
      // 安卓监听返回键
      api.addEventListener({
        name: 'keyback'
      }, function (ret, err) {
        onClose();
      });
    } else if (sys === 'ios') {
      // iOS禁止右滑关闭
      api.setWinAttr({
        slidBackEnabled: false
      });
    }
  }

  function fetchData(reload) {
    // reload, true-重新加载播放器, false-不重载
    console.log('获取数据' + reload)
    $ajax_post('appaudio/audio_detail', {
      user_id: 100000,
      audio_id: _currentId
    }, res1 => {
      var data = { ...res1.audio_detail
      };

      $ajax_post('appcomment/comment_list', {
        user_id: 100000,
        id: _currentId,
        page: 1,
        page_count: 10,
        type: 2,
      }, res2 => {
        var comments = { ...res2
        };

        localStorage.setItem('local_audio_id', _currentId);
        renderFrame(data, comments, reload);

        // 开启自定义事件（关注音频作者）的监听
        // api.addEventListener({
        //   name: 'followAudioAuthor'
        // }, function (ret, err) {
        //   if (ret) {
        //     // console.log(JSON.stringify(ret))

        //     var script = 'vm.fnFollowCallback(' + JSON.stringify(ret.value.type) + ');'
        //     api.execScript({
        //       frameName: 'audio_detail_frm',
        //       script,
        //     });
        //   }
        // });
      });
    });
  }

  function renderFrame(data, comments, reload) {
    console.log('渲染页面')
    // 渲染页面
    api.openFrame({
      name: 'audio_detail_frm',
      url: './audio_detail_frm.html',
      bounces: false,
      reload,
      rect: {
        w: 'auto',
        h: 'auto'
      },
      pageParam: {
        data,
        comments,
        reload,
      },
      useWKWebView: true,
    });
  }

  function switchAudio(id) {
    // 切换音频，重新加载数据
    // _localId = Number(localStorage.getItem('local_audio_id'));
    _currentId = id;
    // console.log(_localId + '_' + _currentId)

    fetchData(true);
  }

  /* function onClose() {
    // 页面不直接关闭处理
    api.closeFrame({
      name: 'audio_detail_list_frm'
    });

    var to = _path.pop() || 'root';

    console.log(JSON.stringify(_path))
    localStorage.setItem('audio_path', _path.join('|'));

    api.openWin({
      name: to,
      animation: {
        type: 'reveal',
        subType: 'from_left',
        duration: 300,
      }
    });
  } */

  function onClose() {
    api.closeWin();
  }
</script>

</html>