<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width" />
  <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
  <link rel="stylesheet" type="text/css" href="../../css/aui/aui.css" />
  <link rel="stylesheet" href="../../css/custom/common.css">
  <style></style>
</head>

<body>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script src="../../script/ajax.js"></script>
<script type="text/javascript">
  var _extends = Object.assign || function (target) {
    for (var i = 1; i < arguments.length; i++) {
      var source = arguments[i];
      for (var key in source) {
        if (Object.prototype.hasOwnProperty.call(source, key)) {
          target[key] = source[key];
        }
      }
    }
    return target;
  };

  var _localId = null,
    // 记录在本地的audio_id
    _currentId = null; // 当前audio_id, 用于和本地的audio_id对比判断是否切换播放源
  // var _path = [];    // 记录当前路径

  apiready = function apiready() {
    _currentId = api.pageParam.id;

    handleSystemBack();

    _localId = Number(localStorage.getItem('local_audio_id'));

    console.log(_localId + '_' + _currentId);
    fetchData(_localId !== _currentId);

    api.addEventListener({
      name: 'openAudio'
    }, function (ret, err) {
      if (ret) {
        if (_currentId !== ret.value.id) {
          _currentId = ret.value.id;
          fetchData(true);
        }
      }
    });
  };

  function handleSystemBack() {
    // 处理系统级的返回操作
    var sys = api.systemType;

    if (sys === 'android') {
      // 安卓监听返回键
      api.addEventListener({
        name: 'keyback'
      }, function (ret, err) {
        onClose();
      });
    } else if (sys === 'ios') {
      // iOS禁止右滑关闭
      api.setWinAttr({
        slidBackEnabled: false
      });
    }
  }

  function fetchData(reload) {
    // reload, true-重新加载播放器, false-不重载
    console.log('获取数据' + reload);
    $ajax_post('appaudio/audio_detail', {
      user_id: 100000,
      audio_id: _currentId
    }, function (res1) {
      var data = _extends({}, res1.audio_detail);

      $ajax_post('appcomment/comment_list', {
        user_id: 100000,
        id: _currentId,
        page: 1,
        page_count: 10,
        type: 2
      }, function (res2) {
        var comments = _extends({}, res2);

        localStorage.setItem('local_audio_id', _currentId);
        renderFrame(data, comments, reload);
      });
    });
  }

  function renderFrame(data, comments, reload) {
    console.log('渲染页面');
    // 渲染页面
    api.openFrame({
      name: 'audio_detail_frm',
      url: './audio_detail_frm.html',
      bounces: false,
      reload: reload,
      rect: {
        w: 'auto',
        h: 'auto'
      },
      pageParam: {
        data: data,
        comments: comments,
        reload: reload
      },
      useWKWebView: true
    });
  }

  function switchAudio(id) {
    // 切换音频，重新加载数据
    _currentId = id;
    // console.log(_localId + '_' + _currentId)

    fetchData(true);
  }


  function onClose() {
    api.closeWin();
  }
</script>

</html>